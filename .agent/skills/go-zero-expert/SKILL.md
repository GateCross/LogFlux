---
name: go-zero-expert
description: go-zero/goctl 后端开发工作流与排障：新增/修改 API（.api/goctl api go/生成代码）、handler/logic/types、httpx.Parse、JWT、middleware、GORM/SQL、sqlmock 单测、分页/过滤、批量删除/清空、路由前缀(/api)、联调与 400/401/404/500 排查。
version: 1.0.0
---

# Go-Zero 开发专家

目标：用最少的步骤，稳定地在 go-zero 项目里新增/修改 API，并能快速定位常见问题。

## 0. 先确认工程形态（很重要）

不同项目对“路由是否允许手写/是否完全 goctl 生成”约束不同。开始前先做一次快速扫描：

- `.api` 文件是否存在：`find backend -maxdepth 3 -name "*.api"`
- 是否使用 goctl：搜索 `goctl api`、`goctl 1.`、`Code generated by goctl`
- 路由是否由生成代码驱动：搜索 `AddRoutes(` / `routes.go`

如果项目明确要求“禁止手动添加路由”，则以 goctl 生成结果为准；不要直接改路由文件。

## 1. 新增/修改 API（goctl 流程）

### 1.1 改 `.api`

在对应模块的 `*.api` 中：
- 增加/修改 request/response type
- 增加/修改 service 的路由与 handler 名称
- 尽量复用已有公共类型（例如 `BaseResp`、`IDReq`）

建议：
- 查询参数：用 `form:"xxx,optional"`；分页字段提供 default
- path 参数：用 `path:"id"`
- body：用 `json:"xxx"`

### 1.2 生成代码（goctl）

常用命令（按项目实际入口替换）：

```bash
cd backend
goctl api go -api api/<entry>.api -dir . -style go_zero
```

生成后优先检查：
- `internal/types`：请求/响应结构体是否符合预期
- `internal/handler/<group>`：handler 是否生成，路由是否接入
- `internal/logic/<group>`：logic 是否生成或可落地

### 1.3 补齐实现（logic 优先）

推荐把核心业务放在 `internal/logic/...`：
- 参数校验（必填/范围/枚举）
- DB/缓存/外部调用
- 事务边界（需要时）
- 可观测性：必要日志（避免刷屏）

## 2. Handler 写法（rest/httpx）

典型 handler 结构：
- `httpx.Parse(r, &req)` 解析
- 调用 logic
- `httpx.OkJsonCtx` / 统一封装返回（以项目约定为准）

排障要点：
- `Parse` 失败通常来自 tag 不匹配（`path/form/json`）或字段类型不对
- `Content-Type` 不对会导致 body 解析失败（前端需 `application/json`）

## 3. 响应与错误处理（建议统一）

建议统一返回结构（示例）：
- `code`：数字/字符串（项目约定）
- `msg`：错误信息
- `data`：业务数据

建议统一“业务错误”与“系统错误”：
- 业务错误：可预期（参数不合法、资源不存在），返回明确 code/msg
- 系统错误：不可预期（DB down、panic），记录日志并返回通用 msg

如果项目已有 `result.HttpResult`/`errorx`/`xerr` 等封装，优先遵循现有方式。

## 4. 数据库（GORM/SQL）常见坑

- 查询过滤：注意 `nil`/空值语义（尤其是 `*int`、`*uint` 的 optional）
- 关联删除：有外键时先删子表，或设置 `OnDelete` 策略
- 批量删除：`WHERE id IN ?`（参数为空时应直接返回成功）
- TRUNCATE：通常需要更高权限；并发场景注意锁表影响

## 5. 测试（sqlmock 优先，先测逻辑）

推荐：
- logic 层用 `sqlmock + gorm` 做单测
- 对“关键 SQL 行为”写 Expect（count/list/update/delete/truncate）
- 空列表/边界值/错误分支要覆盖

## 6. 快速排错清单（按症状）

- 404：路由未注册 / 前端路径不对 / prefix 不一致（如 `/api`）
- 401：JWT 未带 / secret 不一致 / token 过期
- 400：`httpx.Parse` 失败（tag、类型、Content-Type）
- 500：logic 报错未处理/DB 错误/空指针
- 前端拿不到数据：前端 request transform 已提取 `data`，不要再 `.data.data`

## 7. 常用搜索（定位入口）

```bash
rg -n "service .*\\{" backend/api
rg -n "AddRoutes\\(" backend/internal
rg -n "@handler" backend/api
rg -n "type \\w+Req|type \\w+Resp" backend/internal/types
rg -n "httpx\\.Parse|httpx\\.OkJsonCtx" backend/internal/handler
```
