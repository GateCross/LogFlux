# Caddy 配置功能与 UI 规划清单（LogFlux）

## 范围与目标
- **范围**：Caddy 运行配置（本地/容器）、Caddy 配置管理与日志采集链路、前端 Caddy 配置与日志页面布局。
- **目标**：形成可执行的**功能清单**、**优化方向清单**与**执行计划步骤**，便于后续分阶段落地。

---

## 一、当前功能清单（现状）

### 1) Caddy 配置（本地开发）
- 静态资源服务：`root` + `file_server`
- API 反向代理：`/api/* -> 127.0.0.1:8888`
- SPA 路由：`try_files {path} /index.html`
- 压缩：`encode gzip`

### 2) Caddy 配置（Docker/生产）
- Snippets：GeoIP2、压缩、日志 JSON 输出、健康检查、API 反代、静态缓存、安全响应头
- 80/443 双端口：HTTP/HTTPS 分离，生产走完整静态缓存与安全头
- 依赖模块：`caddy-geoip2`、`caddy-dns/cloudflare`、`transform-encoder`

### 3) 后端配置管理
- Caddy 服务器管理（增删改查）：name/url/token/type
- Caddyfile 存储：数据库为单一真源
- 下发与同步：`/load` 推送 + 异步拉 `/config/` 解析日志文件路径
- 自动日志源发现与采集启动

### 4) 前端配置页（结构化编辑）
- 服务器选择与管理、预览/编辑、原始/结构化切换
- 结构化站点列表、站点编辑、路由编辑（Matchers/Handlers）
- 结构化预览（Caddyfile/JSON）与导入导出

### 5) 前端日志页
- 关键字搜索、远程分页表格
- 方法/状态码标签化展示

---

## 二、可优化方向清单（建议）

### A. 配置下发可靠性
- 增加 `/adapt` 预校验，避免无效配置写入与推送
- 推送失败回滚：将“落库 → 推送”改为“推送成功 → 落库”（或引入版本化历史）
- HTTP Client 增加超时/重试；错误信息展示更明确

### B. 日志源发现 & 采集稳定性
- JSON 解析替换正则扫描，提取精确日志输出配置
- 去重与失效路径清理（日志文件路径变化时及时移除）
- 日志落地策略（滚动/保留/压缩）纳入配置

### C. Caddyfile 生产强化
- 启用 HSTS（可配置开关）
- 增加 CSP / Permissions-Policy（可选模板）
- HTTP 自动跳转 HTTPS（生产默认）
- 静态资源 cache-control 更细分（HTML 不缓存）

### D. 结构化编辑能力补全
- 支持更多常见指令：rate_limit、basic_auth、request_body、timeouts 等
- 增加“原样保留块”机制，避免解析丢失

### E. UI/UX 体验优化
- 结构化编辑工具条分组 + sticky
- 左右栏可拖拽分割（可记忆布局）
- 站点/路由卡片支持搜索与折叠摘要
- 校验错误集中展示（可跳转定位）
- 日志表支持时间范围过滤、状态码筛选、详情抽屉

---

## 三、执行计划与步骤（可落地）

### Phase 0：需求确认（1 天）
1. 明确目标场景：单实例/多实例、开发/生产配置差异
2. 确认 Caddy 版本与模块使用范围（GeoIP2 / DNS / encoder）
3. 明确 UI 优先级：配置管理优先还是日志分析优先

### Phase 1：Caddy 配置优化（1–2 天）
1. 加入 HTTPS 重定向/HSTS 等安全配置（可选开关）
2. 统一 80/443 配置片段，减少重复
3. 完善静态缓存策略（HTML 不缓存）
4. 记录配置变更说明（用于发布与回滚）

**输出**：更新 `docker/Caddyfile` 与 `Caddyfile` 的优化版本草案

### Phase 2：后端推送与同步优化（2–3 天）
1. 加入 `/adapt` 预校验接口
2. 推送成功后再落库/或引入版本历史表
3. 日志源解析改为 JSON 解析方式
4. 增加错误提示与可观测指标（推送成功/失败计数）

**输出**：后端接口逻辑调整 + 错误可视化字段

### Phase 3：前端配置与日志 UI（3–5 天）
1. 工具条分组与布局优化（sticky + 自适应）
2. 增加左侧站点搜索、右侧路由折叠/摘要
3. 校验错误集中展示（错误面板）
4. 日志表增加时间范围/状态码/域名过滤、详情抽屉

**输出**：Caddy 配置页 & 日志页 UI 重排版本

### Phase 4：验收与上线（1 天）
1. Caddyfile 验证：`caddy validate` 与 `/adapt` 检查
2. 回归测试：配置保存、推送、日志采集、UI 交互
3. 发布前备份 Caddy 数据目录与配置

---

## 四、验收清单（建议）
- [ ] 原始 Caddyfile 保存与推送成功
- [ ] 结构化编辑导入/导出一致
- [ ] 日志源自动发现准确无重复
- [ ] UI 布局在窄屏/宽屏下可用
- [ ] 关键错误提示清晰可定位

---

## 五、下一步
如需我开始落地，请确认：
1) 优先级（先后端 or 先 UI）  
2) 是否需要 Caddyfile 安全策略默认开启  
3) 是否需要版本化配置历史与回滚功能  
