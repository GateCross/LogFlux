{
  admin :2019
  #debug
  servers {
    trusted_proxies static 127.0.0.1/24 192.168.50.0/24 172.17.0.1/24 172.19.0.1/24
    client_ip_headers X-Forwarded-For X-Real-IP
  }

  order geoip2_vars first
  geoip2 {
    databaseDirectory "/usr/share/GeoIP"
    editionID "GeoLite2-City"
  }

  log {
    output file /var/log/caddy/access.log {
      roll_size 10MB
      roll_keep 10
      roll_keep_for 7d
    }
    format console
  }
}

# ==================================
# 通用配置片段 (Snippets)
# ==================================

# GeoIP2 变量注入
(geoip) {
  geoip2_vars trusted_proxies
}

# 压缩编码
(compression) {
  encode zstd gzip
}

# 日志配置
(logging) {
  log {
    output file /var/log/caddy/access.log
    format json
    level INFO
  }
}

# 健康检查端点
(health_check) {
  handle /api/health {
    respond "OK" 200
  }
}

# API 反向代理
(api_proxy) {
  handle /api/* {
    reverse_proxy localhost:8888 {
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}

      # 超时设置
      transport http {
        read_timeout 30s
        write_timeout 30s
      }
    }
  }
}

# 前端静态文件（完整配置）
(frontend_full) {
  handle {
    root * /app/frontend

    # SPA 路由支持
    try_files {path} /index.html

    file_server {
      # 启用预压缩
      precompressed gzip br
    }

    # 静态资源缓存
    @static {
      path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static {
      Cache-Control "public, max-age=31536000, immutable"
    }

    # HTML 文件不缓存
    @html {
      path *.html
    }
    header @html {
      Cache-Control "no-cache, no-store, must-revalidate"
    }
  }
}

# 前端静态文件（简化配置，用于开发环境）
(frontend_simple) {
  handle {
    root * /app/frontend
    try_files {path} /index.html
    file_server
  }
}

# 安全响应头
(security_headers) {
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    # 如需启用 HSTS，请取消下行注释
    # Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  }
}

# ==================================
# HTTPS 服务
# ==================================
:443 {
  # 导入通用配置
  import geoip
  import compression
  import logging
  import health_check
  import api_proxy
  import frontend_full
  import security_headers
}

# ==================================
# HTTP 服务（开发环境）
# ==================================
:80 {
  # 导入通用配置
  import geoip
  import compression
  import logging
  import health_check
  import api_proxy
  import frontend_simple
}
