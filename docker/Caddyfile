{
  # HTTP 重定向到 HTTPS
  http:// {
    redir https://{host}{uri} permanent
  }
}

# HTTPS 服务
:443 {
  # 启用 GeoIP2
  geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb

  # 编码压缩
  encode zstd gzip

  # 日志配置
  log {
    output file /var/log/caddy/access.log
    format json
    level INFO
  }

  # 健康检查
  handle /api/health {
    respond "OK" 200
  }

  # API 反向代理到后端
  handle /api/* {
    reverse_proxy localhost:8888 {
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}

      # 超时设置
      transport http {
        read_timeout 30s
        write_timeout 30s
      }
    }
  }

  # 前端静态文件
  handle {
    root * /app/frontend

    # 尝试提供文件，否则返回 index.html (SPA 路由支持)
    try_files {path} /index.html

    file_server {
      # 启用预压缩
      precompressed gzip br
    }

    # 静态资源缓存
    @static {
      path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static {
      Cache-Control "public, max-age=31536000, immutable"
    }

    # HTML 文件不缓存
    @html {
      path *.html
    }
    header @html {
      Cache-Control "no-cache, no-store, must-revalidate"
    }
  }

  # 安全头
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    # Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  }
}

# HTTP 服务 (开发环境)
:80 {
  # GeoIP2
  geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb

  # 编码压缩
  encode zstd gzip

  # 日志配置
  log {
    output file /var/log/caddy/access.log
    format json
    level INFO
  }

  # 健康检查
  handle /api/health {
    respond "OK" 200
  }

  # API 反向代理
  handle /api/* {
    reverse_proxy localhost:8888 {
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  # 前端静态文件
  handle {
    root * /app/frontend
    try_files {path} /index.html
    file_server
  }
}
