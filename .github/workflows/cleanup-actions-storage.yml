name: cleanup-actions-storage

on:
  workflow_dispatch:
    inputs:
      target:
        description: '清理目标'
        required: true
        default: all
        type: choice
        options:
          - all
          - caches
          - artifacts
      dry_run:
        description: '仅预览（不实际删除）'
        required: true
        default: false
        type: boolean

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup caches/artifacts
        uses: actions/github-script@v7
        env:
          TARGET: ${{ github.event.inputs.target }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const target = process.env.TARGET || 'all';
            const dryRun = String(process.env.DRY_RUN || 'false') === 'true';

            async function cleanupCaches() {
              let page = 1;
              let listed = 0;
              let deleted = 0;

              while (true) {
                const res = await github.request('GET /repos/{owner}/{repo}/actions/caches', {
                  owner,
                  repo,
                  per_page: 100,
                  page
                });

                const caches = res.data.actions_caches || [];
                if (caches.length === 0) break;

                listed += caches.length;

                for (const cache of caches) {
                  if (!dryRun) {
                    await github.request('DELETE /repos/{owner}/{repo}/actions/caches/{cache_id}', {
                      owner,
                      repo,
                      cache_id: cache.id
                    });
                  }
                  deleted += 1;
                }

                if (caches.length < 100) break;
                page += 1;
              }

              core.info(`[Caches] listed=${listed}, ${dryRun ? 'would_delete' : 'deleted'}=${deleted}`);
              return { listed, deleted };
            }

            async function cleanupArtifacts() {
              let page = 1;
              let listed = 0;
              let deleted = 0;

              while (true) {
                const res = await github.request('GET /repos/{owner}/{repo}/actions/artifacts', {
                  owner,
                  repo,
                  per_page: 100,
                  page
                });

                const artifacts = res.data.artifacts || [];
                if (artifacts.length === 0) break;

                listed += artifacts.length;

                for (const artifact of artifacts) {
                  if (!dryRun) {
                    await github.request('DELETE /repos/{owner}/{repo}/actions/artifacts/{artifact_id}', {
                      owner,
                      repo,
                      artifact_id: artifact.id
                    });
                  }
                  deleted += 1;
                }

                if (artifacts.length < 100) break;
                page += 1;
              }

              core.info(`[Artifacts] listed=${listed}, ${dryRun ? 'would_delete' : 'deleted'}=${deleted}`);
              return { listed, deleted };
            }

            if (target === 'all' || target === 'caches') {
              await cleanupCaches();
            }

            if (target === 'all' || target === 'artifacts') {
              await cleanupArtifacts();
            }
